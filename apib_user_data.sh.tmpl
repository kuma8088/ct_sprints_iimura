#!/bin/bash

# 失敗したらそこで止まる
set -euo pipefail

# アプリケーションの起動
systemctl daemon-reload
systemctl enable --now goserver.service
systemctl enable --now nginx
sudo systemctl enable --now mysqld

# RDS初期化　-----------------------------------------------------------------

DB_HOST="${db_endpoint}"
DB_USER="${db_user}"
DB_PASSWORD="${db_password}"

# RDSが接続可能になるまで待機
# DBに接続できるまでループし続ける（接続できたらuntilが成功してループ終了）
until mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASSWORD" -e ";" ; do
  # 接続に失敗している間はメッセージを出して
  echo "Waiting for database connection..."
  # 5秒待ってから再試行
  sleep 5
done

# サンプルデータの投入(MySQLのエラー対策のため"IF NOT EXISTS/WHERE NOT EXISTS"を挿入)
mysql -h "$DB_HOST" -P 3306 -u "$DB_USER" -p"$DB_PASSWORD" <<'SQL'
CREATE DATABASE IF NOT EXISTS reservation_db;
CREATE TABLE IF NOT EXISTS reservation_db.Reservations (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    company_name VARCHAR(255) NOT NULL,
    reservation_date DATE NOT NULL,
    number_of_people INT NOT NULL
);
INSERT INTO reservation_db.Reservations (company_name, reservation_date, number_of_people)
SELECT '株式会社テスト', '2024-04-21', 5
WHERE NOT EXISTS (SELECT 1 FROM reservation_db.Reservations WHERE company_name = '株式会社テスト' AND reservation_date = '2024-04-21' AND number_of_people = 5)
SQL

# Terraform から templatefile() で db_* 変数が渡される前提
cat >/home/ec2-user/cloudtech-reservation-api/.env <<EOF
DB_USERNAME=${db_user}
DB_PASSWORD=${db_password}
DB_SERVERNAME=${db_endpoint}
DB_PORT=3306
DB_NAME=reservation_db
EOF

# ゾンビプロセスの保険
# :8080 を使用しているプロセスの PID を取得する（-tでPIDのみ、-i :8080でポート指定、見つからなくても失敗で止まらないように '|| true'）
PID=$(sudo lsof -t -i :8080 || true)
# 変数 PID に一つ以上の値が入っているか（空文字でないか）をチェック
if [ -n "$PID" ]; then
  # 見つかった PID を強制終了（SIGKILL）する；複数PIDが返ることもあるのでクォートしないで展開
  sudo kill -9 $PID
fi

sudo systemctl start nginx
sudo systemctl restart goserver.service
